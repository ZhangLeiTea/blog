# 1. 中间件的目标
  
- **不阻塞客户端的请求**。不因DS本身的处理能力、网络不通、网络抖动等因素阻塞客户端的请求，降低客户端的使用要求，例如客户端不再有最大请求数量的限制
- **并发执行sql，提升吞吐量**。DS收到大量的sql执行请求，经过sql依赖关系分析后，确定这些sql事务先后执行顺序，对于可并发的事务，启动多线程并发向mysql-server发起请求
- **自治愈能力**。针对非执行sql本身的错误，能够自我恢复
  - 运行过程中，网络突然不同、网络抖动，不影响ds接受请求，在网络再次联通后，自动执行之前未执行的sql请求

  - 程序崩溃后，未执行的sql，在DS再次启动时将再次执行


# 2. 中间件的功能组件

| 名称             | 英文名称           | 用途                                           |
| :--------------- | :----------------- | :--------------------------------------------- |
| 请求调度器       |                    |                                                |
| 请求处理器       | requestHandler     | 综合使用基础组件，完成请求的处理               |
| 缓存器           | sqlCache           |
| 依赖分析器       | dependenceAnalyser |
| sql执行器        | sqlExecutor        |
| sql连接池        | connetionPool      |
| 启动缓存清理历程 | cacheCleaner       | 在DS启动时，如果缓存中有未执行的任务，优先执行 |


# 3. sql执行器

## 3.1 需要考虑的问题

1. 预编译是居于会话的
2. 如何保证断线重连，断线分为两种情况：mysql-server主动回收；网络抖动。两种方案：定时ping；断线之后重新建立连接（但会有第四点的问题）
3. 在断线重连时，需要重新建立预编译语句
4. 在多sql事务执行的过程中（不是第一个sql执行失败），可能发生断开连接的错误。此时只可能是网络抖动引起，不再尝试断线重连，并不再执行后续的sql，以免发生一个事务的语句在多个会话中执行
5. 发生断线重连后，需要将原先的half-open连接手动关闭，以防出现锁超时导致单sql执行失败，但是未发生锁竞争的其他sql会执行成功，从而破坏事务的原子性
6. 多线程的正常退出，当程序退出后，工作线程要先于主线程退出，完成自己的清理任务










# 存在的bug
1. DS崩溃，此时一个sql执行完成，但未从缓存中删除，则DS再次启动后，会将该sql事务再次执行一次